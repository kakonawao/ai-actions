name: Revise Agent

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'The number of the pull request to revise'
        required: true
        type: number
      branch:
        description: 'The branch to checkout'
        required: true
        type: string
    secrets:
      GEMINI_API_KEY:
        description: 'The API key for the Gemini service'
        required: true
      GITHUB_TOKEN:
        description: 'The GitHub token for CLI authentication'
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  setup:
    uses: ./.github/workflows/setup-agent.yml
    with:
      ref: ${{ inputs.branch }}

  revise-task:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Run revise agent
        run: python agent/main.py
        env:
          AGENT_MODE: "revise"
          PR_NUMBER: ${{ inputs.pr_number }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and push changes
        run: |
          git config --global user.name 'AI Developer'
          git config --global user.email 'ai-developer@users.noreply.github.com'
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "AI revisions for PR #${{ inputs.pr_number }}"
            git push
          fi
