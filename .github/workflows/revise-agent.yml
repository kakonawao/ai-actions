name: Revise Agent

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'The number of the pull request to revise'
        required: true
        type: number
      branch:
        description: 'The branch to checkout'
        required: true
        type: string
    secrets:
      GEMINI_API_KEY:
        description: 'The API key for the Gemini service'
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  revise-task:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository for local actions
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0 # Fetch entire history to ensure main is available for rebase

      - name: Configure Git
        run: |
          git config --global user.name 'AI Developer'
          git config --global user.email 'ai-developer@users.noreply.github.com'

      - name: Debug Git State Before Rebase
        run: |
          echo "--- Git Status (Before Rebase) ---"
          git status
          echo "--- Git Log (last 5, Before Rebase) ---"
          git log --oneline --graph --decorate -5
          echo "--- Git Branch -vv (Before Rebase) ---"
          git branch -vv
          echo "--- Git Diff origin/main (Before Rebase) ---"
          git diff origin/main || true # Use || true to prevent step failure if no diff
          echo "------------------------------------"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Needed for some git commands in private repos

      - name: Rebase onto base branch
        run: |
          git fetch origin main
          git rebase origin/main || {
            echo "Rebase failed. Manual intervention might be required."
            exit 1
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Agent Environment
        uses: ./.github/actions/setup-agent

      - name: Run revise agent
        id: run-agent
        run: python agent/main.py
        env:
          AGENT_MODE: "revise"
          PR_NUMBER: ${{ inputs.pr_number }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug Git State After Agent Run
        run: |
          echo "--- Git Status (After Agent Run) ---"
          git status
          echo "--- Git Diff HEAD (After Agent Run) ---"
          git diff HEAD || true
          echo "--- Git Diff --staged (After Agent Run) ---"
          git diff --staged || true
          echo "------------------------------------"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Needed for some git commands in private repos

      - name: Commit and push changes
        run: |
          if [ -n "${{ steps.run-agent.outputs.changed_files }}" ]; then
            echo "${{ steps.run-agent.outputs.changed_files }}" > .git_add_paths.txt
            git add --pathspec-from-file=.git_add_paths.txt
            rm .git_add_paths.txt
          else
            echo "Error: Agent did not provide any changed files. Failing to prevent unintended commits."
            exit 1
          fi

          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "AI revisions for PR #${{ inputs.pr_number }}"
            git push --force-with-lease origin HEAD:${{ inputs.branch }}
          fi
