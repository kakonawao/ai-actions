name: Revise Agent

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'The number of the pull request to revise'
        required: true
        type: number
      branch:
        description: 'The branch to checkout'
        required: true
        type: string
    secrets:
      GEMINI_API_KEY:
        description: 'The API key for the Gemini service'
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  revise-task:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository for local actions
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0 # Fetch entire history to ensure main is available for rebase

      - name: Configure Git
        run: |
          git config --global user.name 'AI Developer'
          git config --global user.email 'ai-developer@users.noreply.github.com'

      - name: Rebase onto base branch
        run: |
          git fetch origin main
          git rebase origin/main || {
            echo "Rebase failed. Manual intervention might be required."
            exit 1
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Agent Environment
        uses: ./.github/actions/setup-agent

      - name: Run revise agent
        id: run-agent
        run: python agent/main.py
        env:
          AGENT_MODE: "revise"
          PR_NUMBER: ${{ inputs.pr_number }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and push changes
        run: |
          # Stage files
          if [ -n "${{ steps.run-agent.outputs.changed_files }}" ]; then
            echo "${{ steps.run-agent.outputs.changed_files }}" > .git_add_paths.txt
            git add --pathspec-from-file=.git_add_paths.txt
            rm .git_add_paths.txt
          else
            echo "Error: Agent did not provide any changed files. Failing to prevent unintended commits."
            exit 1
          fi

          # Check if there are any staged changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit after agent run."
          else
            # Check if the last commit was by the AI Developer
            LAST_COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
            if [ "$LAST_COMMIT_AUTHOR" = "AI Developer" ]; then
              echo "Amending last commit by AI Developer."
              git commit --amend --no-edit
            else
              echo "Creating new commit for AI revisions."
              git commit -m "AI revisions for PR #${{ inputs.pr_number }}"
            fi
            git push --force-with-lease origin HEAD:${{ inputs.branch }}
          fi
