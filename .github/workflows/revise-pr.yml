name: Revise PR

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'The number of the pull request to revise'
        required: true
        type: number
      branch:
        description: 'The branch to checkout'
        required: true
        type: string
    secrets:
      GEMINI_API_KEY:
        description: 'The API key for the Gemini service'
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  revise-task:
    runs-on: ubuntu-latest
    steps:
      - name: Post in-progress comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ inputs.pr_number }}
          body: |
            Revising the pull request... â³
            
            You can follow the progress of the revision here:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0 # Fetch entire history to ensure main is available for rebase

      - name: Configure Git
        run: |
          git config --global user.name 'AI Developer'
          git config --global user.email 'ai-developer@users.noreply.github.com'

      - name: Rebase onto base branch
        run: |
          git fetch origin main
          git rebase origin/main || {
            echo "Rebase failed. Manual intervention might be required."
            exit 1
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Coding Agent Environment
        uses: kakonawao/ai-actions/.github/actions/setup-coding-agent@main

      - name: Run Coding Agent
        id: run-agent
        uses: kakonawao/ai-actions/.github/actions/run-coding-agent@main
        with:
          agent_mode: "revise"
          pr_number: ${{ inputs.pr_number }}
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and push changes
        id: commit-push
        run: |
          # Stage files
          if [ -n "${{ steps.run-agent.outputs.changed_files }}" ]; then
            echo "${{ steps.run-agent.outputs.changed_files }}" > .git_add_paths.txt
            git add --pathspec-from-file=.git_add_paths.txt
            rm .git_add_paths.txt
          else
            echo "Error: Agent did not provide any changed files. Failing to prevent unintended commits."
            exit 1
          fi

          # Check if there are any staged changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit after agent run."
          else
            # Check if the last commit was by the AI Developer
            LAST_COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
            if [ "$LAST_COMMIT_AUTHOR" = "AI Developer" ]; then
              echo "Amending last commit by AI Developer."
              git commit --amend --no-edit
            else
              echo "Creating new commit for AI revisions."
              git commit -m "AI revisions for PR #${{ inputs.pr_number }}"
            fi
            git push --force-with-lease origin HEAD:${{ inputs.branch }}
          fi

      - name: Update PR Description with Agent Summary
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ inputs.pr_number }}
          SUMMARY: ${{ steps.run-agent.outputs.agent_summary_output }}
        run: |
          # Fetch the current PR body
          CURRENT_BODY=$(gh pr view $PR_NUMBER --json body -q .body)
          
          # Construct the new body
          NEW_BODY=$(cat <<-EOF
          $CURRENT_BODY
          
          ---
          
          ## ðŸ¤– AI Agent Summary (Revision)
          
          $SUMMARY
          EOF
          )
          
          # Update the PR body
          gh pr edit $PR_NUMBER --body "$NEW_BODY"
